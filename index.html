<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voting System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }
      .card {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: none;
      }
      .candidate-card {
        transition: transform 0.2s;
        cursor: pointer;
      }
      .candidate-card:hover {
        transform: translateY(-5px);
      }
      .candidate-card.selected {
        border: 3px solid #28a745;
      }
      .btn-logout {
        position: absolute;
        top: 20px;
        right: 20px;
      }
      .language-switcher {
        position: absolute;
        top: 20px;
        left: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Language Switcher -->
      <div class="language-switcher btn-group">
        <button type="button" class="btn btn-secondary btn-sm" onclick="setLanguage('en')">EN</button>
        <button type="button" class="btn btn-secondary btn-sm" onclick="setLanguage('es')">ES</button>
      </div>

      <!-- Logout Button -->
      <button
        id="logoutBtn"
        class="btn btn-danger btn-logout"
        style="display: none"
        data-translate="logout"
      >
        Logout
      </button>

      <!-- Login/Register Section -->
      <div id="authSection" class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body p-5">
              <h2 class="text-center mb-4" data-translate="voting_system">Voting System</h2>

              <ul class="nav nav-tabs mb-4" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="login-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#login"
                    type="button"
                    data-translate="login"
                  >
                    Login
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="register-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#register"
                    type="button"
                    data-translate="register"
                  >
                    Register
                  </button>
                </li>
              </ul>

              <div class="tab-content">
                <!-- Login Form -->
                <div
                  class="tab-pane fade show active"
                  id="login"
                  role="tabpanel"
                >
                  <form id="loginForm">
                    <div class="mb-3">
                      <label class="form-label" data-translate="username">Username</label>
                      <input
                        type="text"
                        class="form-control"
                        id="loginUsername"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label" data-translate="password">Password</label>
                      <input
                        type="password"
                        class="form-control"
                        id="loginPassword"
                        required
                      />
                    </div>
                    <button type="submit" class="btn btn-primary w-100" data-translate="login_button">
                      Login
                    </button>
                  </form>
                </div>

                <!-- Register Form -->
                <div class="tab-pane fade" id="register" role="tabpanel">
                  <form id="registerForm">
                    <div class="mb-3">
                      <label class="form-label" data-translate="username">Username</label>
                      <input
                        type="text"
                        class="form-control"
                        id="registerUsername"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Email</label>
                      <input
                        type="email"
                        class="form-control"
                        id="registerEmail"
                        required
                      />
                    </div>
                    <div class="mb-3">
                      <label class="form-label" data-translate="password">Password</label>
                      <input
                        type="password"
                        class="form-control"
                        id="registerPassword"
                        required
                      />
                    </div>
                    <button type="submit" class="btn btn-success w-100" data-translate="register_button">
                      Register
                    </button>
                  </form>
                </div>
              </div>

              <div
                id="authMessage"
                class="alert mt-3"
                style="display: none"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Voting Section -->
      <div id="votingSection" style="display: none">
        <div class="row">
          <div class="col-12">
            <div class="card mb-4">
              <div class="card-body">
                <h3 class="text-center mb-0">
                  <span data-translate="welcome">Welcome</span>, <span id="username"></span>!
                </h3>
                <p class="text-center text-muted mb-0" id="voteStatus"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Candidates Section -->
        <div id="candidatesSection">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h4 class="mb-4" data-translate="select_candidate">Select your candidate:</h4>
                  <div id="candidatesList" class="row"></div>
                  <button
                    id="voteBtn"
                    class="btn btn-success btn-lg w-100 mt-4"
                    style="display: none"
                    data-translate="confirm_vote"
                  >
                    Confirm Vote
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mt-4">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h4 class="mb-4" data-translate="voting_results">Voting Results</h4>
                  <button id="showResultsBtn" class="btn btn-info mb-3" data-translate="view_results">
                    View Results
                  </button>
                  <div id="resultsContent" style="display: none">
                    <div id="resultsList"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="votingMessage" class="alert mt-3" style="display: none"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = 'http://127.0.0.1:8000'
      let authToken = null
      let currentUser = null
      let selectedCandidate = null
      let candidates = []
      let currentLang = 'en';

      const translations = {
        en: {
          voting_system: "Voting System",
          login: "Login",
          register: "Register",
          username: "Username",
          password: "Password",
          login_button: "Login",
          register_button: "Register",
          logout: "Logout",
          welcome: "Welcome",
          select_candidate: "Select your candidate:",
          confirm_vote: "Confirm Vote",
          voting_results: "Voting Results",
          view_results: "View Results",
          you_have_voted: "✓ You have already voted",
          you_have_not_voted: "You have not voted yet",
          candidate: "Candidate",
          total_votes: "Total votes",
          votes: "votes",
          registration_successful: "Registration successful! Now please log in.",
          error_registering: "Error during registration",
          connection_error: "Connection error with the server",
          invalid_credentials: "Invalid credentials",
          error_loading_candidates: "Error loading candidates",
          confirm_vote_message: "Are you sure about your vote? You will not be able to change it.",
          vote_successful: "Vote registered successfully!",
          error_voting: "Error while voting",
          error_loading_results: "Error loading results",
        },
        es: {
          voting_system: "Sistema de Votación",
          login: "Iniciar Sesión",
          register: "Registrarse",
          username: "Usuario",
          password: "Contraseña",
          login_button: "Iniciar Sesión",
          register_button: "Registrarse",
          logout: "Cerrar Sesión",
          welcome: "Bienvenido",
          select_candidate: "Selecciona tu candidato:",
          confirm_vote: "Confirmar Voto",
          voting_results: "Resultados de Votación",
          view_results: "Ver Resultados",
          you_have_voted: "✓ Ya has votado",
          you_have_not_voted: "Aún no has votado",
          candidate: "Candidato",
          total_votes: "Total de votos",
          votes: "votos",
          registration_successful: "¡Registro exitoso! Ahora inicia sesión.",
          error_registering: "Error en el registro",
          connection_error: "Error de conexión con el servidor",
          invalid_credentials: "Credenciales inválidas",
          error_loading_candidates: "Error al cargar candidatos",
          confirm_vote_message: "¿Estás seguro de tu voto? No podrás cambiarlo.",
          vote_successful: "¡Voto registrado exitosamente!",
          error_voting: "Error al votar",
          error_loading_results: "Error al cargar resultados",
        }
      };

      function setLanguage(lang) {
        currentLang = lang;
        document.documentElement.lang = lang;
        document.querySelectorAll('[data-translate]').forEach(el => {
          const key = el.getAttribute('data-translate');
          el.textContent = translations[lang][key];
        });
        if(currentUser) {
            updateVoteStatus();
            displayCandidates();
        }
      }

      // Show message
      function showMessage(elementId, message, type) {
        const el = document.getElementById(elementId)
        el.className = `alert alert-${type}`
        el.textContent = message
        el.style.display = 'block'
        setTimeout(() => (el.style.display = 'none'), 5000)
      }

      // Register
      document
        .getElementById('registerForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault()
          const username = document.getElementById('registerUsername').value
          const email = document.getElementById('registerEmail').value
          const password = document.getElementById('registerPassword').value

          try {
            const response = await fetch(`${API_URL}/api/register/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, email, password }),
            })

            if (response.ok) {
              showMessage(
                'authMessage',
                translations[currentLang].registration_successful,
                'success'
              )
              document.getElementById('login-tab').click()
              document.getElementById('registerForm').reset()
            } else {
              const data = await response.json()
              showMessage(
                'authMessage',
                data.error || translations[currentLang].error_registering,
                'danger'
              )
            }
          } catch (error) {
            showMessage(
              'authMessage',
              translations[currentLang].connection_error,
              'danger'
            )
          }
        })

      // Login
      document
        .getElementById('loginForm')
        .addEventListener('submit', async (e) => {
          e.preventDefault()
          const username = document.getElementById('loginUsername').value
          const password = document.getElementById('loginPassword').value

          try {
            const response = await fetch(`${API_URL}/api/login/`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password }),
            })

            if (response.ok) {
              const data = await response.json()
              authToken = data.token
              currentUser = data.user
              showVotingSection()
            } else {
              const data = await response.json()
              showMessage(
                'authMessage',
                data.error || translations[currentLang].invalid_credentials,
                'danger'
              )
            }
          } catch (error) {
            showMessage(
              'authMessage',
              translations[currentLang].connection_error,
              'danger'
            )
          }
        })

      // Logout
      document
        .getElementById('logoutBtn')
        .addEventListener('click', async () => {
          try {
            await fetch(`${API_URL}/api/logout/`, {
              method: 'POST',
              headers: { Authorization: `Token ${authToken}` },
            })
          } catch (error) {
            console.error('Error logging out:', error)
          }

          authToken = null
          currentUser = null
          selectedCandidate = null
          document.getElementById('authSection').style.display = 'block'
          document.getElementById('votingSection').style.display = 'none'
          document.getElementById('logoutBtn').style.display = 'none'
          document.getElementById('loginForm').reset()
        })

        function updateVoteStatus() {
            if (currentUser.has_voted) {
                document.getElementById('voteStatus').textContent = translations[currentLang].you_have_voted;
                document.getElementById('candidatesSection').style.display = 'none';
            } else {
                document.getElementById('voteStatus').textContent = translations[currentLang].you_have_not_voted;
                document.getElementById('candidatesSection').style.display = 'block';
            }
        }

      // Show voting section
      async function showVotingSection() {
        document.getElementById('authSection').style.display = 'none'
        document.getElementById('votingSection').style.display = 'block'
        document.getElementById('logoutBtn').style.display = 'block'
        document.getElementById('username').textContent = currentUser.username

        updateVoteStatus();

        if (!currentUser.has_voted) {
          await loadCandidates()
        }
      }

      // Load candidates
      async function loadCandidates() {
        try {
          const response = await fetch(`${API_URL}/api/candidates/`, {
            headers: { Authorization: `Token ${authToken}` },
          })

          if (response.ok) {
            candidates = await response.json()
            displayCandidates()
          } else {
            showMessage('votingMessage', translations[currentLang].error_loading_candidates, 'danger')
          }
        } catch (error) {
          showMessage(
            'votingMessage',
            translations[currentLang].connection_error,
            'danger'
          )
        }
      }

      // Display candidates
      function displayCandidates() {
        const container = document.getElementById('candidatesList')
        container.innerHTML = ''

        candidates.forEach((candidate) => {
          const col = document.createElement('div')
          col.className = 'col-md-4 mb-3'
          col.innerHTML = `
                    <div class="card candidate-card" data-id="${candidate.id}">
                        <div class="card-body text-center">
                            <h5 class="card-title">${candidate.name}</h5>
                            <p class="text-muted">${translations[currentLang].candidate} #${candidate.id}</p>
                        </div>
                    </div>
                `
          container.appendChild(col)

          col.querySelector('.candidate-card').addEventListener('click', () => {
            selectCandidate(candidate.id)
          })
        })
      }

      // Select candidate
      function selectCandidate(id) {
        selectedCandidate = id
        document.querySelectorAll('.candidate-card').forEach((card) => {
          card.classList.remove('selected')
        })
        document.querySelector(`[data-id="${id}"]`).classList.add('selected')
        document.getElementById('voteBtn').style.display = 'block'
      }

      // Vote
      document.getElementById('voteBtn').addEventListener('click', async () => {
        if (!selectedCandidate) return

        if (!confirm(translations[currentLang].confirm_vote_message)) return

        try {
          const response = await fetch(`${API_URL}/api/vote/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Token ${authToken}`,
            },
            body: JSON.stringify({ candidate: selectedCandidate }),
          })

          if (response.ok) {
            showMessage(
              'votingMessage',
              translations[currentLang].vote_successful,
              'success'
            )
            currentUser.has_voted = true
            updateVoteStatus();
          } else {
            const data = await response.json()
            showMessage(
              'votingMessage',
              data.error || translations[currentLang].error_voting,
              'danger'
            )
          }
        } catch (error) {
          showMessage(
            'votingMessage',
            translations[currentLang].connection_error,
            'danger'
          )
        }
      })

      // Show results
      document
        .getElementById('showResultsBtn')
        .addEventListener('click', async () => {
          try {
            const response = await fetch(`${API_URL}/api/results/`, {
              headers: { Authorization: `Token ${authToken}` },
            })

            if (response.ok) {
              const votes = await response.json()
              displayResults(votes)
              document.getElementById('resultsContent').style.display = 'block'
            } else {
              showMessage(
                'votingMessage',
                translations[currentLang].error_loading_results,
                'danger'
              )
            }
          } catch (error) {
            showMessage(
              'votingMessage',
              translations[currentLang].connection_error,
              'danger'
            )
          }
        })

      // Display results
      function displayResults(votes) {
        const counts = {}
        candidates.forEach((c) => (counts[c.id] = 0))
        votes.forEach((vote) => counts[vote.candidate_id]++)

        const total = votes.length
        let html = '<div class="list-group">'

        candidates.forEach((candidate) => {
          const count = counts[candidate.id]
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0
          html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>${candidate.name}</strong>
                            <span class="badge bg-primary">${count} ${translations[currentLang].votes} (${percentage}%)</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `
        })

        html += '</div>'
        html += `<p class="text-center mt-3"><strong>${translations[currentLang].total_votes}: ${total}</strong></p>`
        document.getElementById('resultsList').innerHTML = html
      }

      // Set initial language
      const userLang = navigator.language || navigator.userLanguage;
      setLanguage(userLang.startsWith('es') ? 'es' : 'en');

    </script>
  </body>
</html>